name: Kit Newsletter Broadcast

on:
  push:
    branches:
      - main
    paths:
      - 'content/ko/posts/**/index.md'

  workflow_dispatch:
    inputs:
      post_path:
        description: 'ÏàòÎèô Î∞úÏÜ°Ìï† Ìè¨Ïä§Ìä∏ Í≤ΩÎ°ú (Ïòà: content/ko/posts/2026-02-08-my-post/index.md)'
        required: false
      send_at:
        description: 'ÏòàÏïΩ Î∞úÏÜ° ÏãúÍ∞Å ISO8601 (ÎπÑÏö∞Î©¥ ÎìúÎûòÌîÑÌä∏ Ï†ÄÏû•)'
        required: false

jobs:
  broadcast:
    runs-on: ubuntu-latest
    # ÎπåÎìú/Î∞∞Ìè¨ ÏõåÌÅ¨ÌîåÎ°úÍ∞Ä ÏÑ±Í≥µÌïú Îí§ÏóêÎßå Ïã§ÌñâÌïòÍ≥† Ïã∂Îã§Î©¥
    # needs: Î•º ÏÇ¨Ïö©ÌïòÎêò, Î≥ÑÎèÑ ÏõåÌÅ¨ÌîåÎ°úÏù¥ÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî ÎèÖÎ¶Ω Ïã§Ìñâ
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ÏßÅÏ†Ñ Ïª§Î∞ãÍ≥º ÎπÑÍµêÌïòÍ∏∞ ÏúÑÌï¥

      - name: Detect new posts
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.post_path }}" ]; then
            # ÏàòÎèô Ìä∏Î¶¨Í±∞: ÏßÄÏ†ïÎêú Í≤ΩÎ°ú ÏÇ¨Ïö©
            echo "${{ github.event.inputs.post_path }}" > /tmp/changed_posts.txt
          else
            # ÏûêÎèô Ìä∏Î¶¨Í±∞: git diffÎ°ú ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú Ìè¨Ïä§Ìä∏ Í∞êÏßÄ
            # A (Added) ÏÉÅÌÉúÏù∏ ÌååÏùºÎßå ÌïÑÌÑ∞ÎßÅÌïòÏó¨ Í∏∞Ï°¥ Ìè¨Ïä§Ìä∏ ÏàòÏ†ï ÏãúÏóêÎäî Î∞úÏÜ°ÌïòÏßÄ ÏïäÏùå
            git diff --name-only --diff-filter=A HEAD~1 HEAD -- 'content/ko/posts/**/index.md' > /tmp/changed_posts.txt || true
          fi

          if [ -s /tmp/changed_posts.txt ]; then
            echo "has_posts=true" >> "$GITHUB_OUTPUT"
            echo "üì¨ New posts detected:"
            cat /tmp/changed_posts.txt
          else
            echo "has_posts=false" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è No new posts detected"
          fi

      - name: Setup Python
        if: steps.detect.outputs.has_posts == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Create Kit broadcast
        if: steps.detect.outputs.has_posts == 'true'
        env:
          KIT_API_KEY: ${{ secrets.KIT_API_KEY }}
          KIT_SEND_AT: ${{ github.event.inputs.send_at || '' }}
          CHANGED_FILES: ${{ steps.detect.outputs.has_posts == 'true' && '' || '' }}
          BASE_URL: 'https://devwrite.ai'
          DEFAULT_LANG: 'ko'
        run: |
          export CHANGED_FILES="$(cat /tmp/changed_posts.txt)"
          python scripts/kit_broadcast.py
